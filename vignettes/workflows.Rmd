---
title: "Complete Workflows: Real-World Examples"
author: "Gilles Colling"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Complete Workflows: Real-World Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview

This vignette demonstrates workflows using corrselect across four domains:

1. Ecological modeling with bioclimatic variables
2. Survey data with redundant items
3. High-dimensional gene expression data
4. Longitudinal data with mixed models

---

## Interface Hierarchy

corrselect provides three interface levels:

**Level 1: corrPrune() / modelPrune()**

- Returns a single pruned dataset
- `corrPrune()`: Based on pairwise correlation
- `modelPrune()`: Based on VIF in regression models

**Level 2: corrSelect() / assocSelect()**

- Returns all maximal subsets satisfying the threshold
- Provides metadata for each subset
- `corrSelect()`: Numeric data
- `assocSelect()`: Mixed-type data (numeric, factor, ordered)

**Level 3: MatSelect()**

- Accepts precomputed correlation/association matrices
- No data preprocessing overhead

---

# Workflow 1: Ecological Modeling

## Ecological Modeling

Species distribution model using 19 WorldClim bioclimatic variables. Many variables are correlated (e.g., different temperature metrics).

### Load data

```{r}
library(corrselect)
data(bioclim_example)

# Data structure
dim(bioclim_example)
head(names(bioclim_example))

# Response variable
summary(bioclim_example$species_richness)
```

Visualize the correlation structure:

```{r, fig.width=8, fig.height=6}
# Correlation matrix
cor_matrix <- cor(bioclim_example[, -1])

# Histogram of correlations
hist(cor_matrix[upper.tri(cor_matrix)],
     breaks = 30,
     main = "Distribution of Pairwise Correlations",
     xlab = "Correlation",
     col = "lightblue",
     border = "white")
abline(v = 0.7, col = "red", lwd = 2, lty = 2)
text(0.7, par("usr")[4] * 0.9, "threshold = 0.7", pos = 4, col = "red")
```

### Correlation-based pruning

```{r}
# Remove highly correlated predictors
bio_clean <- corrPrune(
  data = bioclim_example[, -1],  # Exclude response
  threshold = 0.7,
  mode = "auto"
)

# How much did we reduce?
cat(sprintf("Reduced from %d → %d variables\n",
            ncol(bioclim_example) - 1,
            ncol(bio_clean)))

# Which variables were kept?
head(attr(bio_clean, "selected_vars"), 10)
```

Correlation distribution:

```{r, fig.width=7, fig.height=5}
# Before and after correlations
cor_before <- cor(bioclim_example[, -1])
cor_after <- cor(bio_clean)

# Overlaid histogram
hist(abs(cor_before[upper.tri(cor_before)]),
     breaks = 30,
     main = "Distribution of Absolute Correlations",
     xlab = "Absolute Correlation",
     col = rgb(0.8, 0.2, 0.2, 0.5),
     xlim = c(0, 1))

hist(abs(cor_after[upper.tri(cor_after)]),
     breaks = 30,
     col = rgb(0.2, 0.5, 0.8, 0.5),
     add = TRUE)

abline(v = 0.7, col = "black", lwd = 2, lty = 2)
legend("topright",
       legend = c("Before", "After", "Threshold"),
       fill = c(rgb(0.8, 0.2, 0.2, 0.5), rgb(0.2, 0.5, 0.8, 0.5), NA),
       border = c("black", "black", NA),
       lty = c(NA, NA, 2),
       lwd = c(NA, NA, 2),
       bty = "n")
```

### Fit model

```{r}
# Add response back
bio_clean_full <- data.frame(
  species_richness = bioclim_example$species_richness,
  bio_clean
)

# Fit linear model
model_initial <- lm(species_richness ~ ., data = bio_clean_full)

# Quick summary
cat(sprintf("R² = %.3f\n", summary(model_initial)$r.squared))
cat(sprintf("Adj R² = %.3f\n", summary(model_initial)$adj.r.squared))
```

### VIF-based pruning

```{r}
# Further pruning based on VIF
bio_final <- modelPrune(
  formula = species_richness ~ .,
  data = bio_clean_full,
  limit = 5
)

# Final predictor set
final_vars <- attr(bio_final, "selected_vars")
cat(sprintf("Final model: %d predictors\n", length(final_vars)))
print(final_vars)
```

### Model comparison

```{r}
# Get final model
final_model <- attr(bio_final, "final_model")

# Compare
comparison <- data.frame(
  Model = c("Full model", "After corrPrune", "After modelPrune"),
  R2 = c(
    summary(lm(species_richness ~ ., data = bioclim_example))$r.squared,
    summary(model_initial)$r.squared,
    summary(final_model)$r.squared
  ),
  Adj_R2 = c(
    summary(lm(species_richness ~ ., data = bioclim_example))$adj.r.squared,
    summary(model_initial)$adj.r.squared,
    summary(final_model)$adj.r.squared
  ),
  AIC = c(
    AIC(lm(species_richness ~ ., data = bioclim_example)),
    AIC(model_initial),
    AIC(final_model)
  )
)

print(comparison)
```

Predictor reduction and model quality:

```{r, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))

# Number of predictors
barplot(c(19, length(attr(bio_clean, "selected_vars")), length(final_vars)),
        names.arg = c("Full\n(19 vars)", "corrPrune\n(~8 vars)", "modelPrune\n(~6 vars)"),
        main = "Number of Predictors",
        ylab = "Count",
        col = c("salmon", "lightblue", "lightgreen"),
        ylim = c(0, 20))

# Model quality (Adjusted R²)
barplot(comparison$Adj_R2,
        names.arg = c("Full", "corrPrune", "modelPrune"),
        main = "Adjusted R²",
        ylab = "Value",
        col = c("salmon", "lightblue", "lightgreen"),
        ylim = c(0, 1))
```

### Coefficient stability

```{r, fig.width=10, fig.height=6}
# Extract coefficients (excluding intercept)
coef_full <- coef(lm(species_richness ~ ., data = bioclim_example))[-1]
coef_final <- coef(final_model)[-1]

# Plot for variables present in final model
common_vars <- intersect(names(coef_full), names(coef_final))

par(mfrow = c(1, 2))
barplot(coef_full[common_vars],
        las = 2,
        main = "Full Model",
        ylab = "Coefficient",
        col = "salmon",
        cex.names = 0.6)

barplot(coef_final[common_vars],
        las = 2,
        main = "Final Model (8 vars)",
        ylab = "Coefficient",
        col = "lightblue",
        cex.names = 0.6)
```

---

# Workflow 2: Survey Data Analysis

## Survey Data Analysis

Questionnaire with 30 Likert-scale items measuring satisfaction, engagement, and loyalty. Many items are redundant.

### Load data

```{r}
data(survey_example)

# Data structure
dim(survey_example)
str(survey_example[, 1:10])  # First 10 columns
```

### Prune with protected variables

```{r}
# Exclude respondent_id, overall_satisfaction, and factor variables
survey_predictors <- survey_example[, !(names(survey_example) %in%
                                         c("respondent_id", "overall_satisfaction",
                                           "gender", "education"))]

# Convert ordered factors (Likert items 1-7) to numeric for correlation analysis
survey_numeric <- as.data.frame(lapply(survey_predictors, function(x) {
  if (is.ordered(x)) as.numeric(as.character(x)) else as.numeric(x)
}))

# Prune with protected variables
survey_clean <- corrPrune(
  data = survey_numeric,
  threshold = 0.6,
  force_in = "age"
)

# How many items remain?
cat(sprintf("Reduced from %d → %d variables\n",
            ncol(survey_numeric),
            ncol(survey_clean)))

# Which items were kept?
selected <- attr(survey_clean, "selected_vars")
print(selected)
```

### Construct coverage

```{r}
# Count items per construct
satisfaction_kept <- sum(grepl("satisfaction_", selected))
engagement_kept <- sum(grepl("engagement_", selected))
loyalty_kept <- sum(grepl("loyalty_", selected))

cat(sprintf("Satisfaction: %d/10 items kept\n", satisfaction_kept))
cat(sprintf("Engagement: %d/10 items kept\n", engagement_kept))
cat(sprintf("Loyalty: %d/10 items kept\n", loyalty_kept))
```

Items per construct:

```{r, fig.width=8, fig.height=5}
par(mfrow = c(1, 2))

# Items kept per construct
construct_data <- rbind(
  c(10, 10, 10),
  c(satisfaction_kept, engagement_kept, loyalty_kept)
)

barplot(construct_data,
        beside = TRUE,
        names.arg = c("Satisfaction", "Engagement", "Loyalty"),
        col = c("lightgray", "lightblue"),
        legend.text = c("Original (10)", "After pruning"),
        args.legend = list(x = "topright", bty = "n"),
        main = "Items per Construct",
        ylab = "Number of Items",
        ylim = c(0, 12))

# Percentage reduction
barplot(c(ncol(survey_numeric), ncol(survey_clean)),
        names.arg = c("Before", "After"),
        col = c("salmon", "lightgreen"),
        main = "Total Variables",
        ylab = "Count",
        ylim = c(0, max(ncol(survey_numeric)) * 1.2))
text(0.7, ncol(survey_numeric) + 1, ncol(survey_numeric), pos = 3)
text(1.9, ncol(survey_clean) + 1, ncol(survey_clean), pos = 3)
```

### Model satisfaction

```{r}
# Add response back
survey_model_data <- data.frame(
  overall_satisfaction = survey_example$overall_satisfaction,
  survey_clean
)

# Fit regression model
model_survey <- lm(overall_satisfaction ~ ., data = survey_model_data)

# Summary
summary(model_survey)
```

### Model comparison

```{r}
# Full model (all 30 items + demographics)
full_survey_data <- data.frame(
  overall_satisfaction = survey_example$overall_satisfaction,
  survey_predictors
)

model_full_survey <- lm(overall_satisfaction ~ ., data = full_survey_data)

# Compare
data.frame(
  Model = c("Full (33 vars)", "Pruned (10 vars)"),
  R2 = c(summary(model_full_survey)$r.squared,
         summary(model_survey)$r.squared),
  Adj_R2 = c(summary(model_full_survey)$adj.r.squared,
             summary(model_survey)$adj.r.squared),
  Num_Predictors = c(33, 10)
)
```

---

# Workflow 3: High-Dimensional Data

## High-Dimensional Data

Gene expression data: 200 genes across 100 samples (p >> n).

### Load data

```{r}
data(genes_example)

# Data structure
dim(genes_example)

# Disease prevalence
table(genes_example$disease_status)
```

### Greedy pruning

```{r}
# Extract gene expression data (exclude ID and outcome)
gene_expr <- genes_example[, -(1:2)]

# Greedy pruning
system.time({
  genes_pruned <- corrPrune(
    data = gene_expr,
    threshold = 0.8,
    mode = "greedy"  # Fast for large p
  )
})

# Reduction
cat(sprintf("Reduced from %d → %d genes\n",
            ncol(gene_expr),
            ncol(genes_pruned)))
```

Dimensionality reduction:

```{r, fig.width=8, fig.height=5}
# Barplot showing reduction
reduction_data <- c(ncol(gene_expr), ncol(genes_pruned))
barplot(reduction_data,
        names.arg = c("Original", "After Pruning"),
        main = "Gene Dimensionality Reduction",
        ylab = "Number of Genes",
        col = c("salmon", "lightblue"),
        ylim = c(0, max(reduction_data) * 1.2))
text(0.7, reduction_data[1] + 10, paste(reduction_data[1], "genes"), pos = 3)
text(1.9, reduction_data[2] + 10, paste(reduction_data[2], "genes\n(",
     round(100 * reduction_data[2] / reduction_data[1], 1), "% retained)"), pos = 3)
```

### Exact vs greedy comparison

```{r}
# Subset for comparison
gene_subset <- gene_expr[, 1:50]

# Exact mode
system.time({
  exact_result <- corrPrune(gene_subset, threshold = 0.8, mode = "exact")
})

# Greedy mode
system.time({
  greedy_result <- corrPrune(gene_subset, threshold = 0.8, mode = "greedy")
})

# Compare sizes
cat(sprintf("Exact mode: %d genes kept\n", ncol(exact_result)))
cat(sprintf("Greedy mode: %d genes kept\n", ncol(greedy_result)))
```

### Classification

```{r}
# Prepare classification data
classification_data <- data.frame(
  disease_status = genes_example$disease_status,
  genes_pruned
)

# Logistic regression
model_genes <- glm(disease_status ~ .,
                   data = classification_data,
                   family = binomial())

# Prediction accuracy
predictions <- ifelse(predict(model_genes, type = "response") > 0.5,
                     "Disease", "Healthy")
accuracy <- mean(predictions == genes_example$disease_status)

cat(sprintf("Classification accuracy: %.1f%%\n", accuracy * 100))
```

---

# Workflow 4: Mixed Models

## Mixed Models

Longitudinal data: 50 subjects, 10 timepoints each, 20 correlated predictors.

### Load data

```{r}
data(longitudinal_example)

# Data structure
dim(longitudinal_example)
head(longitudinal_example)

# Study design
cat(sprintf("Subjects: %d\n", length(unique(longitudinal_example$subject))))
cat(sprintf("Sites: %d\n", length(unique(longitudinal_example$site))))
cat(sprintf("Observations per subject: %d\n",
            nrow(longitudinal_example) / length(unique(longitudinal_example$subject))))
```

### Prune fixed effects

```{r, eval=FALSE}
# Note: This example requires lme4 package
library(lme4)

# Define formula with random effects
# Note: Only fixed effects (x1-x5) will be pruned
#       Random effects (1|subject), (1|site) are preserved

pruned_mixed <- modelPrune(
  formula = outcome ~ x1 + x2 + x3 + x4 + x5 + (1|subject) + (1|site),
  data = longitudinal_example,
  engine = "lme4",
  limit = 5
)

# Which fixed effects were kept?
selected_fixed <- attr(pruned_mixed, "selected_vars")
cat("Fixed effects kept:\n")
print(selected_fixed)

# Which were removed?
removed_fixed <- attr(pruned_mixed, "removed_vars")
cat("\nFixed effects removed:\n")
print(removed_fixed)
```

### Final model

```{r, eval=FALSE}
final_mixed <- attr(pruned_mixed, "final_model")
summary(final_mixed)
```

### VIF verification

```{r, eval=FALSE}
# Note: This example requires lme4 package
library(lme4)

# Fit full model
full_formula <- as.formula(paste("outcome ~",
                                 paste(paste0("x", 1:5), collapse = " + "),
                                 "+ (1|subject) + (1|site)"))

model_full_mixed <- lmer(full_formula, data = longitudinal_example)

# Extract fixed effects design matrices
X_full <- getME(model_full_mixed, "X")
X_pruned <- getME(final_mixed, "X")

# Compute VIF
compute_vif <- function(X) {
  X_scaled <- scale(X[, -1])  # Remove intercept
  sapply(1:ncol(X_scaled), function(i) {
    r2 <- summary(lm(X_scaled[, i] ~ X_scaled[, -i]))$r.squared
    1 / (1 - r2)
  })
}

vif_full <- compute_vif(X_full)
vif_pruned <- compute_vif(X_pruned)

# Compare
data.frame(
  Predictor = colnames(X_pruned)[-1],
  VIF_Before = vif_full,
  VIF_After = vif_pruned
)
```

---

# Summary

| Domain | Functions Used |
|--------|----------------|
| Ecology | corrPrune(), modelPrune() |
| Survey | corrPrune() with force_in |
| Genomics | corrPrune(mode = "greedy") |
| Mixed models | modelPrune(engine = "lme4") |

---

# See Also

- `vignette("quickstart")` - Interface overview
- `vignette("advanced")` - Custom engines and algorithmic control
- `vignette("comparison")` - Comparison with alternatives
- `vignette("theory")` - Mathematical foundations

---

# References

**Thresholds**:

- O'Brien, R. M. (2007). A caution regarding rules of thumb for variance inflation factors. *Quality & Quantity*, 41(5), 673-690.
- Dormann, C. F., et al. (2013). Collinearity: a review of methods to deal with it. *Ecography*, 36(1), 27-46.

**Methods**:
- See package documentation and JOSS paper for algorithm details
